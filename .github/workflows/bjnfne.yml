name: BJNFNE's CI

on:
  push:
    branches:
      - main

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install required libs
        run: |
          sudo apt-get update
          sudo apt-get install qtbase5-dev qtscript5-dev qttools5-dev-tools libqt5svg5-dev git build-essential qtchooser qt5-qmake -y

      - name: Clone DiE's submodules
        run: |
            git clone https://github.com/DevX-Cipher/DIE-engine.git
            git clone https://github.com/horsicq/Detect-It-Easy.git
            git clone https://github.com/horsicq/Formats.git
            git clone https://github.com/horsicq/SpecAbstract.git
            git clone https://github.com/horsicq/StaticScan.git
            git clone https://github.com/horsicq/XArchive.git
            git clone https://github.com/horsicq/XQwt.git
            git clone https://github.com/DevX-Cipher/XOptions.git
            git clone https://github.com/horsicq/XStyles.git
            git clone https://github.com/horsicq/XTranslation.git
            git clone https://github.com/horsicq/XDEX.git
            git clone https://github.com/horsicq/FormatDialogs.git
            git clone https://github.com/DevX-Cipher/FormatWidgets.git
            git clone https://github.com/horsicq/Controls.git
            git clone https://github.com/horsicq/XMemoryMapWidget.git
            git clone https://github.com/horsicq/XEntropyWidget.git
            git clone https://github.com/horsicq/XCapstone.git
            git clone https://github.com/horsicq/XHashWidget.git
            git clone https://github.com/horsicq/die_script.git
            git clone https://github.com/horsicq/die_widget.git
            git clone https://github.com/horsicq/nfd_widget.git
            git clone https://github.com/horsicq/archive_widget.git
            git clone https://github.com/horsicq/XMIME.git
            git clone https://github.com/horsicq/XSingleApplication.git
            git clone https://github.com/horsicq/XMIMEWidget.git
            git clone https://github.com/horsicq/XHexView.git
            git clone https://github.com/horsicq/XDisasmView.git
            git clone https://github.com/horsicq/XGithub.git
            git clone https://github.com/horsicq/XShortcuts.git
            git clone https://github.com/horsicq/XHexEdit.git
            git clone https://github.com/horsicq/signatures.git
            git clone https://github.com/horsicq/XDemangle.git
            git clone https://github.com/horsicq/XDemangleWidget.git
            git clone https://github.com/horsicq/build_tools.git
            git clone https://github.com/horsicq/XCppfilt.git
            git clone https://github.com/horsicq/XDynStructs.git
            git clone https://github.com/horsicq/XDynStructsEngine.git
            git clone https://github.com/horsicq/XDynStructsWidget.git
            git clone https://github.com/horsicq/XFileInfo.git
            git clone https://github.com/horsicq/XPDF.git
            git clone https://github.com/horsicq/XInfoDB.git
            git clone https://github.com/horsicq/XSymbolsWidget.git
            git clone https://github.com/horsicq/XOnlineTools.git
            git clone https://github.com/horsicq/XAboutWidget.git
            git clone https://github.com/horsicq/hex_templates.git
            git clone https://github.com/horsicq/XExtractorWidget.git
            git clone https://github.com/horsicq/XExtractor.git
            git clone https://github.com/horsicq/XUpdate.git
            git clone https://github.com/horsicq/XVisualizationWidget.git
            git clone https://github.com/horsicq/XDecompiler.git
            git clone https://github.com/horsicq/XYara.git
            git clone https://github.com/horsicq/yara_widget.git
            git clone https://github.com/horsicq/XDataConvertorWidget.git
            git clone https://github.com/horsicq/XScanEngine.git
            git clone https://github.com/horsicq/XDisasmCore.git
            git clone https://github.com/horsicq/XRegionsWidget.git
            git clone https://github.com/horsicq/XStaticUnpacker.git

      # === DEBUG: Check Controls for xlineedithex ===
      - name: Debug - Check Controls for xlineedithex
        run: |
          echo "=== Files in Controls/ ==="
          ls -la Controls/
          echo ""
          echo "=== Find xlineedithex files anywhere ==="
          find . -name "xlineedithex*" -type f
          echo ""
          echo "=== Check xlineedithex.h exists ==="
          cat Controls/xlineedithex.h 2>/dev/null | head -20 || echo "NOT FOUND!"

      # === DEBUG: Check structure after rsync ===
      - name: Debug - Rsync and verify structure
        run: |
          rsync -av --exclude 'DIE-engine' ./ DIE-engine/
          cd DIE-engine
          echo "=== Directories in DIE-engine ==="
          ls -d */
          echo ""
          echo "=== Test relative path from XEntropyWidget ==="
          ls -la XEntropyWidget/../Controls/xlineedithex.h 2>/dev/null || echo "Relative path FAILED!"
          echo ""
          echo "=== Find xlineedithex in DIE-engine ==="
          find . -name "xlineedithex*" -type f

      - name: Build DiE
        run: |
          cd DIE-engine
          bash -x build_dpkg.sh 2>&1 | tee build.log
        continue-on-error: true

      # === DEBUG: Show failure info ===
      - name: Debug - Build failure info
        if: always()
        run: |
          cd DIE-engine
          echo "=== Last 100 lines of build ==="
          tail -100 build.log 2>/dev/null
          echo ""
          echo "=== INCPATH in Makefiles ==="
          find . -name "Makefile" -exec grep "INCPATH" {} \; 2>/dev/null | head -10

      - name: Upload Release as Download
        if: github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v2
        env:
          RELEASE_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        with:
          tag_name: Beta
          draft: false
          prerelease: true
          files: |
            ${{ env.RELEASE_PATH }}/*.deb
